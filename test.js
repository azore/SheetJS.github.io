/* vim: set ts=2: */
/* binary magic from stuk.github.io/jszip/test/browser-ie-test-utils.js */
function parsetest(x, wb) {
	describe(x + ' should have all bits', function() {
		it('should have all sheets', function() {
			wb.SheetNames.forEach(function(y) { if(!wb.Sheets[y]) throw new Error('bad sheet ' + y); });
		});
	});
}

describe('should parse test files', function() {
	this.timeout(10000);
	[
"12561-1.xls",
"12561-2.xls",
"12843-1.xls",
"12843-2.xls",
"13224.xls",
"13796.xls",
"14330-1.xls",
"14330-2.xls",
"14460.xls",
"15228.xls",
"15375.xls",
"15556.xls",
"15573.xls",
"1900DateWindowing.xls",
"1904DateWindowing.xls",
"19599-1.xls",
"19599-2.xls",
"22742.xls",
"24207.xls",
"24215.xls",
"25183.xls",
"25695.xls",
"26100.xls",
"27272_1.xls",
"27272_2.xls",
"27349-vlookupAcrossSheets.xls",
"27364.xls",
"27394.xls",
"27852.xls",
"27933.xls",
"28772.xls",
"28774.xls",
"29675.xls",
"29942.xls",
"29982.xls",
"30070.xls",
"30540.xls",
"30978-alt.xls",
"30978-deleted.xls",
"31661.xls",
"31749.xls",
"31979.xls",
"32822.xls",
"33082.xls",
"34775.xls",
"35564.xls",
"35565.xls",
"36947.xls",
"37376.xls",
"37630.xls",
"37684-1.xls",
"37684-2.xls",
"37684.xls",
"39234.xls",
"39512.xls",
"39634.xls",
"3dFormulas.xls",
"40285.xls",
"41139.xls",
"41546.xls",
"42464-ExpPtg-bad.xls",
"42464-ExpPtg-ok.xls",
"42726.xls",
"42844.xls",
"43251.xls",
"43493.xls",
"43623.xls",
"43902.xls",
"44010-SingleChart.xls",
"44010-TwoCharts.xls",
"44167.xls",
"44200.xls",
"44201.xls",
"44235.xls",
"44297.xls.pending",
"44593.xls.pending",
"44636.xls",
"44643.xls",
"44693.xls",
"44840.xls",
"44861.xls",
"44891.xls",
"44958.xls",
"45129.xls",
"45290.xls",
"45322.xls",
"45365-2.xls",
"45365.xls",
"45492.xls",
"45538_classic_Footer.xls",
"45538_classic_Header.xls",
"45538_form_Footer.xls",
"45538_form_Header.xls",
"45672.xls",
"45720.xls",
"45761.xls",
"45784.xls",
"46136-NoWarnings.xls",
"46136-WithWarnings.xls",
"46137.xls",
"46250.xls",
"46368.xls",
"46445.xls",
"46904.xls.pending",
"47034.xls",
"47154.xls",
"47251.xls",
"47701.xls",
"47847.xls",
"47920.xls",
"47924.xls",
"48026.xls",
"48180.xls",
"48325.xls",
"48703.xls",
"48968.xls",
"49096.xls",
"49185.xls",
"49219.xls",
"49524.xls",
"49529.xls",
"49581.xls",
"49612.xls",
"49751.xls",
"49761.xls",
"49896.xls",
"49928.xls",
"49931.xls",
"50020.xls",
"50298.xls",
"50426.xls",
"50756.xls",
"50779_1.xls",
"50779_2.xls",
"50833.xls.pending",
"50939.xls",
"51143.xls",
"51461.xls",
"51498.xls",
"51535.xls",
"51670.xls",
"51675.xls",
"51832.xls.pending",
"52527.xls",
"52575_main.xls",
"52575_source.xls",
"53404.xls",
"53446.xls.pending",
"53588.xls",
"53798_shiftNegative_TMPL.xls",
"53972.xls",
"54016.xls",
"54206.xls",
"54686_fraction_formats.xls",
"55341_CellStyleBorder.xls",
"AbnormalSharedFormulaFlag.xls",
"AreaErrPtg.xls",
"BOOK_in_capitals.xls",
"CodeFunctionTestCaseData.xls",
"ColumnStyle1dp.xls",
"ColumnStyle1dpColoured.xls",
"ColumnStyleNone.xls",
"ComplexFunctionTestCaseData.xls",
"ContinueRecordProblem.xls",
"DBCSHeader.xls",
"DBCSSheetName.xls",
"DateFormats.xls",
"DeltaFunctionTestCaseData.xls",
"DrawingAndComments.xls",
"DrawingContinue.xls",
"EmbeddedChartHeaderTest.xls",
"Employee.xls",
"ErrPtg.xls",
"FactDoubleFunctionTestCaseData.xls",
"ForShifting.xls",
"FormatChoiceTests.xls",
"Formatting.xls",
"FormulaEvalTestData.xls",
"FormulaRefs.xls",
"HyperlinksOnManySheets.xls",
"IfFormulaTest.xls",
"ImRealFunctionTestCaseData.xls",
"ImaginaryFunctionTestCaseData.xls",
"IndexFunctionTestCaseData.xls",
"IndirectFunctionTestCaseData.xls",
"IntersectionPtg.xls",
"IrrNpvTestCaseData.xls",
"LookupFunctionsTestCaseData.xls",
"MRExtraLines.xls",
"MatchFunctionTestCaseData.xls",
"MissingBits.xls",
"NoGutsRecords.xls",
"OddStyleRecord.xls",
"PercentPtg.xls",
"QuotientFunctionTestCaseData.xls",
"RangePtg.xls",
"ReadOnlyRecommended.xls",
"ReferencePtg.xls",
"RepeatingRowsCols.xls",
"ReptFunctionTestCaseData.xls",
"RkNumber.xls",
"RomanFunctionTestCaseData.xls",
"SampleSS.xls",
"SharedFormulaTest.xls",
"SheetWithDrawing.xls",
"Simple.xls",
"SimpleChart.xls",
"SimpleMultiCell.xls",
"SimpleWithAutofilter.xls",
"SimpleWithChoose.xls",
"SimpleWithColours.xls",
"SimpleWithComments.xls",
"SimpleWithDataFormat.xls",
"SimpleWithFormula.xls",
"SimpleWithImages-mac.xls",
"SimpleWithImages.xls",
"SimpleWithPageBreaks.xls",
"SimpleWithPrintArea.xls",
"SimpleWithSkip.xls",
"SimpleWithStyling.xls",
"SingleLetterRanges.xls",
"SolverContainerAfterSPGR.xls",
"SquareMacro.xls",
"StringContinueRecords.xls",
"StringFormulas.xls",
"SubtotalsNested.xls",
"TestRandBetween.xls",
"TwoSheetsNoneHidden.xls",
"TwoSheetsOneHidden.xls",
"UncalcedRecord.xls",
"UnionPtg.xls",
"WORKBOOK_in_capitals.xls",
"WeekNumFunctionTestCaseData.xls",
"WeekNumFunctionTestCaseData2013.xls",
"WithChart.xls",
"WithCheckBoxes.xls",
"WithConditionalFormatting.xls",
"WithEmbeddedObjects.xls",
"WithExtendedStyles.xls",
"WithFormattedGraphTitle.xls",
"WithHyperlink.xls",
"WithThreeCharts.xls",
"WithTwoCharts.xls",
"WithTwoHyperLinks.xls",
"WrongFormulaRecordType.xls",
"XRefCalc.xls",
"XRefCalcData.xls",
"atp.xls",
"blankworkbook.xls",
"bug_42794.xls",
"colwidth.xls",
"comments.xls",
"countblankExamples.xls",
"countifExamples.xls",
"dg-text.xls",
"drawings.xls",
"duprich1.xls",
"duprich2.xls",
"dvEmpty.xls",
"empty.xls",
"ex41187-19267.xls",
"ex42564-21435.xls",
"ex42564-21503.xls",
"ex42564-elementOrder.xls",
"ex42570-20305.xls.pending",
"ex44921-21902.xls",
"ex45046-21984.xls",
"ex45582-22397.xls",
"ex45672.xls",
"ex45698-22488.xls.pending",
"ex45978-extraLinkTableSheets.xls",
"ex46548-23133.xls",
"ex47747-sharedFormula.xls",
"excel_with_embeded.xls",
"excelant.xls",
"externalFunctionExample.xls",
"finance.xls",
"formula_stress_test.xls",
"intercept.xls",
"large_strings.xls.pending",
"missingFuncs44675.xls",
"mortgage-calculation.xls",
"multibookFormulaA.xls",
"multibookFormulaB.xls",
"namedinput.xls",
"noHeaderFooter47244.xls",
"number_format.xls",
"ole2-embedding.xls",
"overlapSharedFormula.xls",
"password.xls.pending",
"rank.xls",
"rk.xls",
"shared_formulas.xls",
"sumifformula.xls",
"sumifs.xls",
"templateExcelWithAutofilter.xls",
"testArraysAndTables.xls",
"testNames.xls",
"testRRaC.xls",
"testRVA.xls",
"text.xls",
"unicodeNameRecord.xls",
"yearfracExamples.xls",

"45430.xlsx",
"45540_classic_Footer.xlsx",
"45540_classic_Header.xlsx",
"45540_form_Footer.xlsx",
"45540_form_Header.xlsx",
"45544.xlsx",
"46535.xlsx",
"46536.xlsx",
"47090.xlsx",
"47504.xlsx",
"47668.xlsx",
"47737.xlsx",
"47804.xlsx",
"47813.xlsx.pending",
"47862.xlsx",
"47889.xlsx",
"48495.xlsx",
"48539.xlsx",
"48703.xlsx",
"48779.xlsx",
"48923.xlsx",
"49156.xlsx",
"49273.xlsx",
"49325.xlsx",
"49609.xlsx",
"49783.xlsx",
"49872.xlsx",
"49928.xlsx",
"49966.xlsx",
"50096.xlsx",
"50299.xlsx",
"50784-font_theme_colours.xlsx",
"50786-indexed_colours.xlsx",
"50795.xlsx",
"50846-border_colours.xlsx",
"50867_with_table.xlsx",
"51222.xlsx",
"51470.xlsx",
"51710.xlsx",
"51850.xlsx",
"51963.xlsx",
"52348.xlsx",
"52716.xlsx",
"53101.xlsx",
"53282.xlsx",
"53568.xlsx",
"53734.xlsx",
"53798.xlsx",
"53798_shiftNegative_TMPL.xlsx",
"54071.xlsx",
"54084 - Greek - beyond BMP.xlsx",
"54206.xlsx",
"54288-ref.xlsx",
"54288.xlsx",
"54436.xlsx",
"54524.xlsx",
"54607.xlsx",
"55640.xlsx",
"55745.xlsx",
"55850.xlsx",
"AverageTaxRates.xlsx",
"Booleans.xlsx",
"BrNotClosed.xlsx",
"CustomXMLMapping-singleattributenamespace.xlsx",
"CustomXMLMappings-complex-type.xlsx",
"CustomXMLMappings.xlsx",
"CustomXmlMappings-inverse-order.xlsx",
"DataValidations-49244.xlsx",
"DateFormatTests.xlsx",
"ElapsedFormatTests.xlsx",
"ForShifting.xlsx",
"FormatChoiceTests.xlsx",
"FormatConditionTests.xlsx",
"Formatting.xlsx",
"FormulaEvalTestData_Copy.xlsx",
"GeneralFormatTests.xlsx",
"GroupTest.xlsx",
"InlineStrings.xlsx",
"NewlineInFormulas.xlsx",
"NumberFormatApproxTests.xlsx",
"NumberFormatTests.xlsx",
"RepeatingRowsCols.xlsx",
"SampleSS.xlsx",
"ShrinkToFit.xlsx",
"SimpleMultiCell.xlsx",
"SimpleWithComments.xlsx",
"Tables.xlsx",
"TextFormatTests.xlsx",
"TwoSheetsNoneHidden.xlsx",
"TwoSheetsOneHidden.xlsx",
"WithChart.xlsx",
"WithChartSheet.xlsx.pending",
"WithConditionalFormatting.xlsx",
"WithDrawing.xlsx",
"WithEmbeded.xlsx",
"WithMoreVariousData.xlsx",
"WithTable.xlsx",
"WithTextBox.xlsx",
"WithTextBox2.xlsx",
"WithThreeCharts.xlsx",
"WithTwoCharts.xlsx",
"WithVariousData.xlsx",
"atp.xlsx",
"chart_sheet.xlsx.pending",
"comments.xlsx",
"excel-reader-xlsx_data01.xlsx",
"excel-reader-xlsx_data02.xlsx",
"excel-reader-xlsx_error02.xlsx.pending",
"excel-reader-xlsx_error03.xlsx.pending",
"excel-reader-xlsx_error04.xlsx.pending",
"excel-reader-xlsx_error05.xlsx.pending",
"excel-reader-xlsx_error06.xlsx.pending",
"excel-reader-xlsx_error07.xlsx.pending",
"excel-reader-xlsx_error08.xlsx.pending",
"excel-reader-xlsx_inline01.xlsx",
"excel-reader-xlsx_libre01.xlsx",
"formula_stress_test.xlsx",
"interview.xlsx",
"issue.xlsx",
"jxls-core_formulaOneRow.xlsx",
"jxls-core_simple.xlsx",
"jxls-examples_stress1.xlsx",
"jxls-examples_stress2.xlsx",
"jxls-reader_departmentData.xlsx",
"mixed_sheets.xlsx",
"named_ranges_2011.xlsx",
"openpyxl_g_NameWithValueBug.xlsx",
"openpyxl_g_empty-no-string.xlsx",
"openpyxl_g_empty-with-styles.xlsx",
"openpyxl_g_empty.xlsx",
"openpyxl_g_empty_libre.xlsx",
"openpyxl_g_empty_no_dimensions.xlsx",
"openpyxl_g_empty_with_no_properties.xlsx.pending",
"openpyxl_g_guess_types.xlsx",
"openpyxl_g_libreoffice_nrt.xlsx",
"openpyxl_g_merge_range.xlsx",
"openpyxl_r_complex-styles.xlsx",
"openpyxl_r_conditional-formatting.xlsx",
"openpyxl_r_contains_chartsheets.xlsx.pending",
"openpyxl_r_date_1900.xlsx",
"openpyxl_r_date_1904.xlsx",
"openpyxl_r_formulae.xlsx",
"openpyxl_r_null_archive.xlsx.pending",
"openpyxl_r_null_file.xlsx.pending",
"picture.xlsx",
"reordered_sheets.xlsx",
"sample-beta.xlsx.pending",
"sample.xlsx",
"shared_formulas.xlsx",
"sheetProtection_allLocked.xlsx",
"sheetProtection_not_protected.xlsx",
"styles.xlsx",
"workbookProtection_not_protected.xlsx",
"workbookProtection_workbook_revision_protected.xlsx",
"workbookProtection_workbook_structure_protected.xlsx",
"workbookProtection_workbook_windows_protected.xlsx",
"workbookProtection_worksheet_protected.xlsx",
"xlrd_reveng1.xlsx",
"xlrd_text_bar.xlsx",
"xlsx-jdbc.xlsx",
"חישוב_נקודות_זיכוי.xlsx.pending"
	].forEach(function(x) {
		it(x, x.substr(-8) == ".pending" ? null : function(done) {
			var oReq;
			if(typeof window.XMLHttpRequest !== "undefined" || typeof XMLHttpRequest !== "undefined") oReq = new XMLHttpRequest();
			else oReq = new ActiveXObject("Microsoft.XMLHTTP");
			oReq.open("GET", '/test_files/' + x, true);
			if(oReq.overrideMimeType) oReq.overrideMimeType('text\/plain; charset=x-user-defined');
			if(typeof oReq.responseType !== "undefined") oReq.responseType = "arraybuffer";
			var f = function(e) {
				var wb;
				var arr = new Array();
				if(typeof oReq.responseType !== "undefined") {
					var arraybuffer = oReq.response;
					var data = new Uint8Array(arraybuffer);
					for(var i = 0; i != data.length; ++i) arr[i] = data[i];
					wb = x.substr(-1) == "s" ? XLS.read(arr, {type:'array'})
						: XLSX.read(arr.map(function(x) { return String.fromCharCode(x); }).join(""), {type:'binary'});
				} else {
					var binary = oReq.responseBody;
					var byteMapping = {};
					for ( var i = 0; i < 256; i++ ) {
						for ( var j = 0; j < 256; j++ ) {
							byteMapping[ String.fromCharCode( i + (j << 8) ) ] = String.fromCharCode(i) + String.fromCharCode(j);
						}
					}
					var rawBytes = IEBinaryToArray_ByteStr(binary);
					var lastChr = IEBinaryToArray_ByteStr_Last(binary);
					var data = rawBytes.replace(/[\s\S]/g, function( match ) { return byteMapping[match]; }) + lastChr;
					for(var i = 0; i != data.length; ++i) arr[i] = data.charCodeAt(i) & 0xff;
					wb = x.substr(-1) == "s" ? XLS.read(arr, {type:'array'})
						: XLSX.read(arr.map(function(x) { return String.fromCharCode(x); }).join(""), {type:'binary'});
				}
				parsetest(x, wb);
				done();
			}
			try { oReq.onload = f; } catch(e) { 
				oReq.onreadystatechange = function() {
					if(oReq.readyState !== 4) return false;
					if(oReq.status != 200) throw "bad request: " + oReq.status;
					var binary = oReq.responseBody;
					var byteMapping = {};
					for ( var i = 0; i < 256; i++ ) {
						for ( var j = 0; j < 256; j++ ) {
							byteMapping[ String.fromCharCode( i + (j << 8) ) ] = String.fromCharCode(i) + String.fromCharCode(j);
						}
					}
					var rawBytes = IEBinaryToArray_ByteStr(binary);
					var lastChr = IEBinaryToArray_ByteStr_Last(binary);
					var data = rawBytes.replace(/[\s\S]/g, function( match ) { return byteMapping[match]; }) + lastChr;
					var arr = [];
					for(var i = 0; i != data.length; ++i) arr[i] = data.charCodeAt(i) & 0xff;
					wb = x.substr(-1) == "s" ? XLS.read(arr, {type:'array'})
						: XLSX.read(arr.map(function(x) { return String.fromCharCode(x); }).join(""), {type:'binary'});
					parsetest(x, wb);
					done();
				};
			}
			oReq.send();
		});
	});
});
